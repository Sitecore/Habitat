/**
* Created by IntelliJ IDEA.
*
* User: phil
* Date: 15/11/12
* Time: 11:04 AM
*
*/
"use strict";

(function ($) {

  var self = this,
      container,
      running = false,
      currentY = 0,
      targetY = 0,
      oldY = 0,
      maxScrollTop = 0,
      minScrollTop,
      direction,
      onRenderCallback = null,
      fricton = 0.95,
      // higher value for slower deceleration
  vy = 0,
      stepAmt = 1,
      minMovement = 0.1,
      ts = 0.1;

  var updateScrollTarget = function updateScrollTarget(amt) {
    targetY += amt;
    vy += (targetY - oldY) * stepAmt;

    oldY = targetY;
  };
  var render = function render() {
    if (vy < -minMovement || vy > minMovement) {

      currentY = currentY + vy;
      if (currentY > maxScrollTop) {
        currentY = vy = 0;
      } else if (currentY < minScrollTop) {
        vy = 0;
        currentY = minScrollTop;
      }

      container.scrollTop(-currentY);

      vy *= fricton;

      //   vy += ts * (currentY-targetY);
      // scrollTopTweened += settings.tweenSpeed * (scrollTop - scrollTopTweened);
      // currentY += ts * (targetY - currentY);

      if (onRenderCallback) {
        onRenderCallback();
      }
    }
  };
  var animateLoop = function animateLoop() {
    if (!running) return;
    requestAnimFrame(animateLoop);
    render();
    //log("45","animateLoop","animateLoop", "",stop);
  };
  var onWheel = function onWheel(e) {
    e.preventDefault();
    var evt = e.originalEvent;

    var delta = evt.detail ? evt.detail * -1 : evt.wheelDelta / 40;
    var dir = delta < 0 ? -1 : 1;
    if (dir != direction) {
      vy = 0;
      direction = dir;
    }

    updateScrollTarget(delta);
  };

  /*
   * http://paulirish.com/2011/requestanimationframe-for-smart-animating/
   */
  window.requestAnimFrame = (function () {
    return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function (callback) {
      window.setTimeout(callback, 1000 / 60);
    };
  })();

  /*
   * http://jsbin.com/iqafek/2/edit
   */
  var normalizeWheelDelta = (function () {
    // Keep a distribution of observed values, and scale by the
    // 33rd percentile.
    var distribution = [],
        done = null,
        scale = 30;
    return function (n) {
      // Zeroes don't count.
      if (n == 0) return n;
      // After 500 samples, we stop sampling and keep current factor.
      if (done != null) return n * done;
      var abs = Math.abs(n);
      // Insert value (sorted in ascending order).
      outer: do {
        // Just used for break goto
        for (var i = 0; i < distribution.length; ++i) {
          if (abs <= distribution[i]) {
            distribution.splice(i, 0, abs);
            break outer;
          }
        }
        distribution.push(abs);
      } while (false);
      // Factor is scale divided by 33rd percentile.
      var factor = scale / distribution[Math.floor(distribution.length / 3)];
      if (distribution.length == 500) done = factor;
      return n * factor;
    };
  })();

  $.fn.smoothWheel = function () {
    //  var args = [].splice.call(arguments, 0);
    var options = jQuery.extend({}, arguments[0]);
    return this.each(function (index, elm) {

      if (!('ontouchstart' in window)) {
        container = $(this);
        container.bind("mousewheel", onWheel);
        container.bind("DOMMouseScroll", onWheel);
        currentY = targetY = 0;
        minScrollTop = container.get(0).clientHeight - container.get(0).scrollHeight;
        if (options.onRender) {
          onRenderCallback = options.onRender;
        }
        if (options.remove) {
          log("122", "smoothWheel", "remove", "");
          running = false;
          container.unbind("mousewheel", onWheel);
          container.unbind("DOMMouseScroll", onWheel);
        } else if (!running) {
          running = true;
          animateLoop();
        }
      }
    });
  };
})(jQuery);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkQ6L0hBQklUQVQvc3JjL2ZlYXR1cmUvTWVkaWEvY29kZS9TY3JpcHRzL01lZGlhL2pxdWVyeS5zbW9vdGh3aGVlbC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBUUEsQ0FBQyxVQUFVLENBQUMsRUFBRTs7QUFFWixNQUFJLElBQUksR0FBRyxJQUFJO01BQUUsU0FBUztNQUFFLE9BQU8sR0FBRyxLQUFLO01BQUUsUUFBUSxHQUFHLENBQUM7TUFBRSxPQUFPLEdBQUcsQ0FBQztNQUFFLElBQUksR0FBRyxDQUFDO01BQUUsWUFBWSxHQUFHLENBQUM7TUFBRSxZQUFZO01BQUUsU0FBUztNQUFFLGdCQUFnQixHQUFHLElBQUk7TUFDNUksT0FBTyxHQUFHLElBQUk7O0FBQ2QsSUFBRSxHQUFHLENBQUM7TUFDTixPQUFPLEdBQUcsQ0FBQztNQUNYLFdBQVcsR0FBRyxHQUFHO01BQ2pCLEVBQUUsR0FBRyxHQUFHLENBQUM7O0FBRWpCLE1BQUksa0JBQWtCLEdBQUcsU0FBckIsa0JBQWtCLENBQWEsR0FBRyxFQUFFO0FBQ3RDLFdBQU8sSUFBSSxHQUFHLENBQUM7QUFDZixNQUFFLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFBLEdBQUksT0FBTyxDQUFDOztBQUVqQyxRQUFJLEdBQUcsT0FBTyxDQUFDO0dBR2hCLENBQUE7QUFDRCxNQUFJLE1BQU0sR0FBRyxTQUFULE1BQU0sR0FBZTtBQUN2QixRQUFJLEVBQUUsR0FBRyxDQUFFLFdBQVcsQUFBQyxJQUFJLEVBQUUsR0FBRyxXQUFXLEVBQUU7O0FBRTNDLGNBQVEsR0FBSSxRQUFRLEdBQUcsRUFBRSxBQUFDLENBQUM7QUFDM0IsVUFBSSxRQUFRLEdBQUcsWUFBWSxFQUFFO0FBQzNCLGdCQUFRLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztPQUNuQixNQUFNLElBQUksUUFBUSxHQUFHLFlBQVksRUFBRTtBQUNsQyxVQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ1AsZ0JBQVEsR0FBRyxZQUFZ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QUFDO1NBQ2Y7T0FFRjtLQUNGLENBQUMsQ0FBQztHQUNKLENBQUM7Q0FHSCxDQUFBLENBQUUsTUFBTSxDQUFDLENBQUMiLCJmaWxlIjoidW5kZWZpbmVkIiwic291cmNlc0NvbnRlbnQiOlsi77u/LyoqXHJcbiAqIENyZWF0ZWQgYnkgSW50ZWxsaUogSURFQS5cclxuICpcclxuICogVXNlcjogcGhpbFxyXG4gKiBEYXRlOiAxNS8xMS8xMlxyXG4gKiBUaW1lOiAxMTowNCBBTVxyXG4gKlxyXG4gKi9cclxuKGZ1bmN0aW9uICgkKSB7XHJcblxyXG4gIHZhciBzZWxmID0gdGhpcywgY29udGFpbmVyLCBydW5uaW5nID0gZmFsc2UsIGN1cnJlbnRZID0gMCwgdGFyZ2V0WSA9IDAsIG9sZFkgPSAwLCBtYXhTY3JvbGxUb3AgPSAwLCBtaW5TY3JvbGxUb3AsIGRpcmVjdGlvbiwgb25SZW5kZXJDYWxsYmFjayA9IG51bGwsXHJcbiAgICAgICAgICBmcmljdG9uID0gMC45NSwgLy8gaGlnaGVyIHZhbHVlIGZvciBzbG93ZXIgZGVjZWxlcmF0aW9uXHJcbiAgICAgICAgICB2eSA9IDAsXHJcbiAgICAgICAgICBzdGVwQW10ID0gMSxcclxuICAgICAgICAgIG1pbk1vdmVtZW50ID0gMC4xLFxyXG4gICAgICAgICAgdHMgPSAwLjE7XHJcblxyXG4gIHZhciB1cGRhdGVTY3JvbGxUYXJnZXQgPSBmdW5jdGlvbiAoYW10KSB7XHJcbiAgICB0YXJnZXRZICs9IGFtdDtcclxuICAgIHZ5ICs9ICh0YXJnZXRZIC0gb2xkWSkgKiBzdGVwQW10O1xyXG5cclxuICAgIG9sZFkgPSB0YXJnZXRZO1xyXG5cclxuXHJcbiAgfVxyXG4gIHZhciByZW5kZXIgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAodnkgPCAtKG1pbk1vdmVtZW50KSB8fCB2eSA+IG1pbk1vdmVtZW50KSB7XHJcblxyXG4gICAgICBjdXJyZW50WSA9IChjdXJyZW50WSArIHZ5KTtcclxuICAgICAgaWYgKGN1cnJlbnRZID4gbWF4U2Nyb2xsVG9wKSB7XHJcbiAgICAgICAgY3VycmVudFkgPSB2eSA9IDA7XHJcbiAgICAgIH0gZWxzZSBpZiAoY3VycmVudFkgPCBtaW5TY3JvbGxUb3ApIHtcclxuICAgICAgICB2eSA9IDA7XHJcbiAgICAgICAgY3VycmVudFkgPSBtaW5TY3JvbGxUb3A7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnRhaW5lci5zY3JvbGxUb3AoLWN1cnJlbnRZKTtcclxuXHJcbiAgICAgIHZ5ICo9IGZyaWN0b247XHJcblxyXG4gICAgICAvLyAgIHZ5ICs9IHRzICogKGN1cnJlbnRZLXRhcmdldFkpO1xyXG4gICAgICAvLyBzY3JvbGxUb3BUd2VlbmVkICs9IHNldHRpbmdzLnR3ZWVuU3BlZWQgKiAoc2Nyb2xsVG9wIC0gc2Nyb2xsVG9wVHdlZW5lZCk7XHJcbiAgICAgIC8vIGN1cnJlbnRZICs9IHRzICogKHRhcmdldFkgLSBjdXJyZW50WSk7XHJcblxyXG4gICAgICBpZiAob25SZW5kZXJDYWxsYmFjaykge1xyXG4gICAgICAgIG9uUmVuZGVyQ2FsbGJhY2soKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICB2YXIgYW5pbWF0ZUxvb3AgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICBpZiAoIXJ1bm5pbmcpIHJldHVybjtcclxuICAgIHJlcXVlc3RBbmltRnJhbWUoYW5pbWF0ZUxvb3ApO1xyXG4gICAgcmVuZGVyKCk7XHJcbiAgICAvL2xvZyhcIjQ1XCIsXCJhbmltYXRlTG9vcFwiLFwiYW5pbWF0ZUxvb3BcIiwgXCJcIixzdG9wKTtcclxuICB9XHJcbiAgdmFyIG9uV2hlZWwgPSBmdW5jdGlvbiAoZSkge1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgdmFyIGV2dCA9IGUub3JpZ2luYWxFdmVudDtcclxuXHJcbiAgICB2YXIgZGVsdGEgPSBldnQuZGV0YWlsID8gZXZ0LmRldGFpbCAqIC0xIDogZXZ0LndoZWVsRGVsdGEgLyA0MDtcclxuICAgIHZhciBkaXIgPSBkZWx0YSA8IDAgPyAtMSA6IDE7XHJcbiAgICBpZiAoZGlyICE9IGRpcmVjdGlvbikge1xyXG4gICAgICB2eSA9IDA7XHJcbiAgICAgIGRpcmVjdGlvbiA9IGRpcjtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVTY3JvbGxUYXJnZXQoZGVsdGEpO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBodHRwOi8vcGF1bGlyaXNoLmNvbS8yMDExL3JlcXVlc3RhbmltYXRpb25mcmFtZS1mb3Itc21hcnQtYW5pbWF0aW5nL1xyXG4gICAqL1xyXG4gIHdpbmRvdy5yZXF1ZXN0QW5pbUZyYW1lID0gKGZ1bmN0aW9uICgpIHtcclxuICAgIHJldHVybiB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8XHJcbiAgICAgICAgICAgIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcclxuICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxyXG4gICAgICAgICAgICB3aW5kb3cub1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxyXG4gICAgICAgICAgICB3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcclxuICAgICAgICAgICAgZnVuY3Rpb24gKGNhbGxiYWNrKSB7XHJcbiAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7XHJcbiAgICAgICAgICAgIH07XHJcblxyXG5cclxuICB9KSgpO1xyXG5cclxuICAvKlxyXG4gICAqIGh0dHA6Ly9qc2Jpbi5jb20vaXFhZmVrLzIvZWRpdFxyXG4gICAqL1xyXG4gIHZhciBub3JtYWxpemVXaGVlbERlbHRhID0gZnVuY3Rpb24gKCkge1xyXG4gICAgLy8gS2VlcCBhIGRpc3RyaWJ1dGlvbiBvZiBvYnNlcnZlZCB2YWx1ZXMsIGFuZCBzY2FsZSBieSB0aGVcclxuICAgIC8vIDMzcmQgcGVyY2VudGlsZS5cclxuICAgIHZhciBkaXN0cmlidXRpb24gPSBbXSwgZG9uZSA9IG51bGwsIHNjYWxlID0gMzA7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gKG4pIHtcclxuICAgICAgLy8gWmVyb2VzIGRvbid0IGNvdW50LlxyXG4gICAgICBpZiAobiA9PSAwKSByZXR1cm4gbjtcclxuICAgICAgLy8gQWZ0ZXIgNTAwIHNhbXBsZXMsIHdlIHN0b3Agc2FtcGxpbmcgYW5kIGtlZXAgY3VycmVudCBmYWN0b3IuXHJcbiAgICAgIGlmIChkb25lICE9IG51bGwpIHJldHVybiBuICogZG9uZTtcclxuICAgICAgdmFyIGFicyA9IE1hdGguYWJzKG4pO1xyXG4gICAgICAvLyBJbnNlcnQgdmFsdWUgKHNvcnRlZCBpbiBhc2NlbmRpbmcgb3JkZXIpLlxyXG4gICAgICBvdXRlcjogZG8geyAvLyBKdXN0IHVzZWQgZm9yIGJyZWFrIGdvdG9cclxuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRpc3RyaWJ1dGlvbi5sZW5ndGg7ICsraSkge1xyXG4gICAgICAgICAgaWYgKGFicyA8PSBkaXN0cmlidXRpb25baV0pIHtcclxuICAgICAgICAgICAgZGlzdHJpYnV0aW9uLnNwbGljZShpLCAwLCBhYnMpO1xyXG4gICAgICAgICAgICBicmVhayBvdXRlcjtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgZGlzdHJpYnV0aW9uLnB1c2goYWJzKTtcclxuICAgICAgfSB3aGlsZSAoZmFsc2UpO1xyXG4gICAgICAvLyBGYWN0b3IgaXMgc2NhbGUgZGl2aWRlZCBieSAzM3JkIHBlcmNlbnRpbGUuXHJcbiAgICAgIHZhciBmYWN0b3IgPSBzY2FsZSAvIGRpc3RyaWJ1dGlvbltNYXRoLmZsb29yKGRpc3RyaWJ1dGlvbi5sZW5ndGggLyAzKV07XHJcbiAgICAgIGlmIChkaXN0cmlidXRpb24ubGVuZ3RoID09IDUwMCkgZG9uZSA9IGZhY3RvcjtcclxuICAgICAgcmV0dXJuIG4gKiBmYWN0b3I7XHJcbiAgICB9O1xyXG4gIH0oKTtcclxuXHJcblxyXG4gICQuZm4uc21vb3RoV2hlZWwgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAvLyAgdmFyIGFyZ3MgPSBbXS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDApO1xyXG4gICAgdmFyIG9wdGlvbnMgPSBqUXVlcnkuZXh0ZW5kKHt9LCBhcmd1bWVudHNbMF0pO1xyXG4gICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsbSkge1xyXG5cclxuICAgICAgaWYgKCEoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSkge1xyXG4gICAgICAgIGNvbnRhaW5lciA9ICQodGhpcyk7XHJcbiAgICAgICAgY29udGFpbmVyLmJpbmQoXCJtb3VzZXdoZWVsXCIsIG9uV2hlZWwpO1xyXG4gICAgICAgIGNvbnRhaW5lci5iaW5kKFwiRE9NTW91c2VTY3JvbGxcIiwgb25XaGVlbCk7XHJcbiAgICAgICAgY3VycmVudFkgPSB0YXJnZXRZID0gMDtcclxuICAgICAgICBtaW5TY3JvbGxUb3AgPSBjb250YWluZXIuZ2V0KDApLmNsaWVudEhlaWdodCAtIGNvbnRhaW5lci5nZXQoMCkuc2Nyb2xsSGVpZ2h0O1xyXG4gICAgICAgIGlmIChvcHRpb25zLm9uUmVuZGVyKSB7XHJcbiAgICAgICAgICBvblJlbmRlckNhbGxiYWNrID0gb3B0aW9ucy5vblJlbmRlcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlKSB7XHJcbiAgICAgICAgICBsb2coXCIxMjJcIiwgXCJzbW9vdGhXaGVlbFwiLCBcInJlbW92ZVwiLCBcIlwiKTtcclxuICAgICAgICAgIHJ1bm5pbmcgPSBmYWxzZTtcclxuICAgICAgICAgIGNvbnRhaW5lci51bmJpbmQoXCJtb3VzZXdoZWVsXCIsIG9uV2hlZWwpO1xyXG4gICAgICAgICAgY29udGFpbmVyLnVuYmluZChcIkRPTU1vdXNlU2Nyb2xsXCIsIG9uV2hlZWwpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoIXJ1bm5pbmcpIHtcclxuICAgICAgICAgIHJ1bm5pbmcgPSB0cnVlO1xyXG4gICAgICAgICAgYW5pbWF0ZUxvb3AoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuXHJcbn0pKGpRdWVyeSk7Il19
